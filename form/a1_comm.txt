;ГРС Красноусольск
; 06.2019 - Галеев
#include "eval.lib\valtrack.evl"
#include "eval.lib\yahont.evl"
#include "eval.lib\bupg24_3.evl"
#include "eval.lib\sgoes.evl"
#include "eval.lib\bom2.evl"
#include "eval.lib\vbp.evl"
;#include "eval.lib\2is3.evl"
;#include "eval.lib\uug.evl"
; недостоверность сигналов эр-04
; только для датчиков рвых при нерасширенном диапазоне
;

; ПС 2 из 3 меньше, если достоверен только 1 датчик, не вырабатывать
; mux - множитель типа 90%
; тратит 3 переменные
; 

func ps2is3Lt(p1,p2,p3,mux,pzad,T,vi)

  a1=valTrackLt(p1,0.01*mux*pzad,T,vi)
  a2=valTrackLt(p2,0.01*mux*pzad,T,vi+1)
  a3=valTrackLt(p3,0.01*mux*pzad,T,vi+2)
  if (ge(dost(p1)+dost(p3)+dost(p3),2))
    return (ge(a1+a2+a3,2))
  endif
return(0)
endfunc

; ПС 2 из 3 больше, если достоверен только 1 датчик, не вырабатывать
; mux - множитель типа 110%
; тратит 3 переменные
; 
func ps2is3Gt(p1,p2,p3,mux,pzad,T,vi)

  a1=valTrackGt(p1,0.01*mux*pzad,T,vi)
  a2=valTrackGt(p2,0.01*mux*pzad,T,vi+1)
  a3=valTrackGt(p3,0.01*mux*pzad,T,vi+2)
  if (ge(dost(p1)+dost(p3)+dost(p3),2))
    return (ge(a1+a2+a3,2))
  return(a3)
  endif
return(0)
endfunc


; val,i - значение и индекс измерения
; dostval,di - значение и индекс достоверного измерения
; если val достоверно, возвращает индекс ближайшего из двух к среднему
; иначе водвращает di
;
func idostnearest(med,v1,i1,v2,i2,ii)
  if(dost(v1)&dost(v2))
    if(gt(abs(med-v1),abs(med-v2)+0.002)) ;+0.002 - чтобы убрать дребезг
      return(i2)
 	else
 	  return(i1)
	endif
  else
    return(ii)
  endif
endfunc


; расчет индекса датчика давления для регулятора на двух эр-04
; 0 - эр04-12, 1 - эр04-21, 2 - эр04-22, подача в том же порядке
;
func regp3i(p1,p2,p3,self)
 
  i=0
  c=0
  p=0

  if (dost(p1))
    c=c+1
    p=p+p1
  endif
  

  if (dost(p2))
    i=1
    c=c+1
    p=p+p2
  endif

  if (dost(p3))
    i=2
    c=c+1
    p=p+p3
  endif
  

  if(c) 
    p=p/c
    i=idostnearest(p,p1,0,p3,2,i)
    i=idostnearest(p,p2,1,p1,0,i)
    i=idostnearest(p,p3,2,p2,1,i)
  else
    i=self
  endif

  return(i)
endfunc


func er04_nedost(p)
 return(!dost(p)|lt(p,0.1)|gt(p,15.9))
endfunc 

; ********** Функция вычисления qd, qy 
; t      - время устройства на этом шаге
; vs_sys - vsum, параметр непрерывный расход (исходный для всех расчетов)
; qf_sys - fix, параметр, где фиксируется непрер накопленный расход 
;          при смене контр часа (уст извне, чтобы хранить)
; qy_sys - sys параметра qy (уст извне, чтобы хранить)
; qd_ind - индекс расчетной переменной qd
; qmax   - максимальный возможный расход за сутки, больше - недост
; chour  - контрактный час
; aout[vi+0] - расход с начала суток
; aout[vi+1] - для слежения за изменением времени
;
func upd_qyqd(t,vs_sys,qf_sys,qy_sys,vi,qmax,chour) 
  if (ne(hour(t),hour(aout[vi+1]))&eq(hour(t),chour)) ; наступил контр час, в sevc местное время
    qy=#[vs_sys]-#[qf_sys]
    if (lt(qy,0)|gt(qy,qmax))			   ; значение qy некорректно
      qy=false(qy)
    endif
    set qy_sys,qy				   ; qy текущий накоп - накоп на момент послед сут
    set qf_sys,#[vs_sys]                           ; накоп на момент послед сут запоминаем в zond.tmp
    sleep(2)                    		   ; будем польз новым знач QF_SYS
  endif
  aout[vi]=#[vs_sys]-#[qf_sys];            	   ; расход c начала суток
  aout[vi+1]=t
endfunc

;-----------------------------------------------------
func oninit(t)
  
  initouts 150,0,50
 
 
   ; ждем первого опроса модулей
  sleep(3*18)
   ; автозапуск
  ; 
  set {АЛГ АВОСТ КРАС}[sys_num],{АВТОЗАПУСК1}
  set {АЛГ БАЙП КРАС}[sys_num],{АВТОЗАПУСК2}
  ;set {АЛГ СЛИВ КРАС}[sys_num],{АВТОЗАПУСК3}
  set {АЛГ ОТСПГ КРАС}[sys_num],{АВТОЗАПУСК4}
endfunc
;--- настройка автозапуска
;
set {АВТОЗАПУСК1}[sys_num],{АЛГ АВОСТ КРАС}
set {АВТОЗАПУСК2}[sys_num],{АЛГ БАЙП КРАС}
;set {АВТОЗАПУСК3}[sys_num],{АЛГ СЛИВ КРАС}
set {АВТОЗАПУСК4}[sys_num],{АЛГ ОТСПГ КРАС}
;--- давление на входе ГРС
dout[1]=lt({РВХ КРАС},{РВХ МИН КРАС})	; ПС Pвх низ 
dout[2]=gt({РВХ КРАС},{РВХ МАКС КРАС})	; ПС Pвх выс 
;--- давление на выходе 
dout[3]=lt({РВЫХ Д1 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 пониж по 1 каналу
dout[4]=gt({РВЫХ Д1 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 повыш по 1 каналу
dout[5]=lt({РВЫХ Д2 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 низ по 2 каналу 
dout[6]=gt({РВЫХ Д2 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 выс по 2 каналу 
dout[7]=lt({РВЫХ Д3 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 низ по 3 каналу 
dout[8]=gt({РВЫХ Д3 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 выс по 3 каналу 
; давление газа на выходе низкое
dout[9]=ps2is3Lt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},90,{РВЫХ ЗАД КРАС},10,150)
; давление газа на выходе высокое
dout[10]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},111,{РВЫХ ЗАД КРАС},10,153)
; давление газа на выходе предельно-низкое
dout[11]=ps2is3Lt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},87,{РВЫХ ЗАД КРАС},40,156) 
; давление газа на выходе предельно-высокое
dout[12]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},112,{РВЫХ ЗАД КРАС},40,159)
; давление газа на выходе опасно-высокое
dout[13]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},110,{РВЫХ ЗАД КРАС},10,162)
; давление газа на выходе аварийно-высокое
dout[14]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},115,{РВЫХ ЗАД КРАС},10,165)
; последняя 167
; --- температура газа
dout[15]=lt({ТВЫХ КРАС},-10)	; Твых1 низ
dout[16]=lt({ТВЫХ КРАС},0)  	; Твых1 пониж
dout[17]=gt({ПГ ТВЫХ КРАС},60)	; Твых ПГ высокая
;--- температура в помещениях
dout[18]=valTrackGt({ТВЗД ОПЕР КРАС},70,10,168)	; Твоз опер высокая 
dout[19]=valTrackLt({ТВЗД ОПЕР КРАС},5,10,169)	; Твоз опер низкая 
;dout[20]=valTrackGt({ТВЗД ТОПЧ КРАС},70,10,170)	; Твоз топоч высокая 
;dout[21]=valTrackLt({ТВЗД ТОПЧ КРАС},5,10,171)	; Твоз топоч низкая 
dout[22]=valTrackGt({ТВЗД ПЕР КРАС},70,10,172)	; Твоз перкл высокая
dout[23]=valTrackGt({ТВЗД РЕД КРАС},70,10,173)	; Твоз редуц высокая
;dout[24]=valTrackGt({ТВЗД РАСХ КРАС},70,10,174)	; Твоз расходм высокая 
;dout[25]=valTrackGt({ТВЗД ОДО КРАС},70,10,175)	; Твоз одор высокая 
; --- пожар на ГРС по двум сигналам
dout[26]=valTrack(eq({ЯХПЖ ОПЕР КРАС},2)&{ТВ ОПЕР В КРАС},10,176)    ; пожар в операторной
;dout[27]=valTrack(eq({ЯХПЖ ТОПЧ КРАС},2)&{ТВ ТОП В КРАС},10,177)     ; пожар в топочной
dout[28]=valTrack(eq({ЯХПЖ ПЕР КРАС},2)&{ТВ ПЕР В КРАС},10,178)     ; пожар в бл.переключ
dout[29]=valTrack(eq({ЯХПЖ РЕД КРАС},2)&{ТВ РЕД В КРАС},10,179)     ; пожар в бл.редуц
;dout[30]=valTrack(eq({ЯХПЖ РАСХ КРАС},2)&{ТВ РАСХ В КРАС},10,180)     ; пожар в расходомерной
;dout[31]=valTrack(eq({ЯХПЖ ОДОР КРАС},2)&{ТВ ОДОР В КРАС},10,181)     ; пожар в бл.одоризации
; --- перепад на фильтрах
dout[32]=gt({DP ФИЛЬТ1 КРАС},{DР ФЛ ПВ КРАС}) 		; перепад на фильтре1 повыш 
dout[33]=gt({DP ФИЛЬТ1 КРАС},{DР ФЛ В КРАС}) 		; перепад на фильтре1 выс 
dout[34]=gt({DP ФИЛЬТ2 КРАС},{DР ФЛ ПВ КРАС}) 		; перепад на фильтре2 повыш 
dout[35]=gt({DP ФИЛЬТ2 КРАС},{DР ФЛ В КРАС}) 		; перепад на фильтре2 выс 
; --- сработка ППК
dout[36]=gt({РСВ ЛИН КРАС},{РСВЛ МАКС КРАС})	;открытие ппк
; ---- УУГ
dout[37]=valTrackGt({1SF dР КРАС},{DРУГ1МАКС КРАС},20,182)  ; перепад выс
dout[38]=valTrackLt({1SF dР КРАС},{DРУУГ1МИН КРАС},20,183)   ; перепад низ
dout[39]=valTrackGt({1SF Р КРАС},{РУУГ1МАКС КРАС},20,184)  ; давление выс
dout[40]=valTrackLt({1SF Р КРАС},{РУУГ1МИН КРАС},20,185)   ; давление низ
;  давление на регуляторе (на командном газе)
; P < P ВТГ - резерв(0) , P ВТГ <= P <=P ВАГ - работа(1), P > P ВАГ - авария(2)
dout[41]=gt({РРЕГ1 КРАС},{РРЕГ1 ВТГ КРАС})+gt({РРЕГ1 КРАС},{РРЕГ1 ВАГ КРАС})
dout[42]=gt({РРЕГ2 КРАС},{РРЕГ2 ВТГ КРАС})+gt({РРЕГ2 КРАС},{РРЕГ2 ВАГ КРАС})
;---- модули
;dout[43]=
; --- исправность каналов эр-04 4 шт
dout[44]=!dost({ПОЗ ЗАДВ КРАС}) 
dout[45]=er04_nedost({РВЫХ Д1 КРАС})
dout[46]=er04_nedost({РВЫХ Д2 КРАС})
dout[47]=er04_nedost({РВЫХ Д3 КРАС})

;---- состояние грс
#include "KRASNOUS\FORM\sost_grs.evl"
dout[48]=sost_grs(0)

;----------- переcчет в кг --------
aout[49]=({РВХ КРАС}*10.19716)
aout[50]=({РВЫХ Д1 КРАС}*10.19716)
aout[51]=({РВЫХ Д2 КРАС}*10.19716)
aout[52]=({РВЫХ Д3 КРАС}*10.19716)
aout[53]=({РВЫХ123 КРАС}*10.19716)

;------ Расчет обьема газа при работе на байпасе -----
x=Vbp({КРАН БАЙП КРАС},{1SF ПРСУТ КРАС},54) ; 5переменных


; большой расход на байпасе
;
dout[66]=valTrackGt({ПОЗ ЗАДВ КРАС},97,120,192)

; расчет индекса канала давления для регулятора на двух эр-04
x=0
x=x|eq({2ЭР04 КРАС},0)
x=x|eq(dost({РВЫХ Д2 КРАС})&dost({РВЫХ Д3 КРАС}),0)

if(x)
  dout[67]=0
else
  dout[67]=regp3i({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},dout[59])
endif

; если разница между сигналом управления и фактич положением задвижки велика
; значит Роторк застрял
dout[68]=valTrackGt(abs({ПОЗ ЗАДВ КРАС}-{УПР ЗАДВ КРАС}),5,90,191)


;--------------- sevc ------------------------------------

x=upd_qyqd({ВРЕМЯSEVC КРАС},{VСУМ SEVC КРАС}[sys_num],{VНАС SEVC КРАС}[sys_num],{QY SEVC КРАС}[sys_num],61,5000,12)

;--------------- БОМ ОВЕН---------------------------------
x=bomOven(121,{БОМСТАТ1 КРАС},{БОМСТАТ2 КРАС})
;---- ИБП
dout[72]=valTrackGt({I НАГ ИБП КРАС},0.9*{IМАКС ИБП КРАС},2,186) ; ток нагрузки ибп высокий (номинально smart 30А)
dout[73]=gt({Т ИНВ ИБП КРАС},70)               		  ; перегрев ибп
dout[74]=lt({UВХ ИБП КРАС},185)                 	          ; u вх ибп низкое
dout[75]=gt({UВХ ИБП КРАС},245)                		  ; u вх ибп высокое
;---------------- Яхонт 4и -------------------------
a=yahont4(76,{ЯХ ШЛ1})
a=yahont4(77,{ЯХ ШЛ2})
a=yahont4(78,{ЯХ ШЛ3})
a=yahont4(79,{ЯХ ШЛ4})
a=yahont41(80,{ЯХ КОРПУС})
a=yahont42(81,{ЯХ ОСНОВН ИП})
a=yahont42(82,{ЯХ РЕЗЕРВ ИП})

; --- уставки УКЗ
aout[83]=121.9+{СКЗ ИМПУЛ КРАС}/3200
dout[84]=valTrackGt({СКЗ E КРАС},{EСКЗ МАКС КРАС},10,187) ; пот скз высокий 
dout[85]=valTrackLt({СКЗ E КРАС},{EСКЗ МИН КРАС},10,188)  ; пот скз низкий 
dout[86]=valTrackGt({СКЗ I КРАС},{IСКЗ МАКС КРАС},10,189) ; ток скз высокий 
dout[87]=valTrackGt({СКЗ U КРАС},{UСКЗ МАКС КРАС},10,190) ; u скз высокое 

;-------------- СГОЭС --------------------------
dout[88]=sgoes_avar({1СГОЭС КОД})
dout[89]=gt({СН4 ПЕР КРАС},10)
dout[90]=gt({СН4 ПЕР КРАС},20)
dout[91]=sgoes_avar({2СГОЭС КОД})
dout[92]=gt({СН4 РЕД КРАС},10)
dout[93]=gt({СН4 РЕД КРАС},20)
; -------------- БУПГ24-3 -----------------------
x=bupg243(100,{ПГ СОСТ})	
x=bupg243_klap(114,{ПГ СОС КЛ})

