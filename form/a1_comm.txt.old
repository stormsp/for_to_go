;ГРС Красноусольск
; 06.2019 - Галеев



#include "eval.lib\valtrack.evl"
#include "eval.lib\yahont.evl"
#include "eval.lib\bupg24_3.evl"
#include "eval.lib\sgoes.evl"
#include "eval.lib\bom2.evl"
#include "eval.lib\vbp.evl"
#include "eval.lib\2is3.evl"


; недостоверность сигналов эр-04
; только для датчиков рвых при нерасширенном диапазоне
;
func er04_nedost(p)
 return(!dost(p)|lt(p,0.1)|gt(p,15.9))
endfunc 




;-----------------------------------------------------
func oninit(t)
  
  initouts 150,0,50
 
 
   ; ждем первого опроса модулей
  sleep(3*18)
   ; автозапуск
  ; 
  set {АЛГ АВОСТ КРАС}[sys_num],{АВТОЗАПУСК1}
  set {АЛГ БАЙП КРАС}[sys_num],{АВТОЗАПУСК2}
  ;set {АЛГ СЛИВ КРАС}[sys_num],{АВТОЗАПУСК3}
  set {АЛГ ОТСПГ КРАС}[sys_num],{АВТОЗАПУСК4}
endfunc

;--- настройка автозапуска
;
set {АВТОЗАПУСК1}[sys_num],{АЛГ АВОСТ КРАС}
set {АВТОЗАПУСК2}[sys_num],{АЛГ БАЙП КРАС}
;set {АВТОЗАПУСК3}[sys_num],{АЛГ СЛИВ КРАС}
set {АВТОЗАПУСК4}[sys_num],{АЛГ ОТСПГ КРАС}

;--- давление на входе ГРС
dout[1]=lt({РВХ КРАС},{РВХ МИН КРАС})	; ПС Pвх низ 
dout[2]=gt({РВХ КРАС},{РВХ МАКС КРАС})	; ПС Pвх выс 

;--- давление на выходе 
dout[3]=lt({РВЫХ Д1 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 пониж по 1 каналу
dout[4]=gt({РВЫХ Д1 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 повыш по 1 каналу
dout[5]=lt({РВЫХ Д2 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 низ по 2 каналу 
dout[6]=gt({РВЫХ Д2 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 выс по 2 каналу 
dout[7]=lt({РВЫХ Д3 КРАС},0.92*{РВЫХ ЗАД КРАС})	; ПС Рвых1 низ по 3 каналу 
dout[8]=gt({РВЫХ Д3 КРАС},1.08*{РВЫХ ЗАД КРАС})	; ПС Рвых1 выс по 3 каналу 

; давление газа на выходе низкое
dout[9]=ps2is3Lt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},90,{РВЫХ ЗАД КРАС},10,150)
; давление газа на выходе высокое
dout[10]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},111,{РВЫХ ЗАД КРАС},10,153)
; давление газа на выходе предельно-низкое
dout[11]=ps2is3Lt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},87,{РВЫХ ЗАД КРАС},40,156) 
; давление газа на выходе предельно-высокое
dout[12]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},112,{РВЫХ ЗАД КРАС},40,159)
; давление газа на выходе опасно-высокое
dout[13]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},110,{РВЫХ ЗАД КРАС},10,162)
; давление газа на выходе аварийно-высокое
dout[14]=ps2is3Gt({РВЫХ Д1 КРАС},{РВЫХ Д2 КРАС},{РВЫХ Д3 КРАС},115,{РВЫХ ЗАД КРАС},10,165)
; последняя 167

; --- температура газа
dout[15]=lt({ТВЫХ КРАС},-10)	; Твых1 низ
dout[16]=lt({ТВЫХ КРАС},0)  	; Твых1 пониж
dout[17]=gt({ПГ ТВЫХ КРАС},60)	; Твых ПГ высокая

;--- температура в помещениях
dout[18]=valTrackGt({ТВЗД ОПЕР КРАС},70,10,168)	; Твоз опер высокая 
dout[19]=valTrackLt({ТВЗД ОПЕР КРАС},5,10,169)	; Твоз опер низкая 
;dout[20]=valTrackGt({ТВЗД ТОПЧ КРАС},70,10,170)	; Твоз топоч высокая 
;dout[21]=valTrackLt({ТВЗД ТОПЧ КРАС},5,10,171)	; Твоз топоч низкая 
dout[22]=valTrackGt({ТВЗД ПЕР КРАС},70,10,172)	; Твоз перкл высокая
dout[23]=valTrackGt({ТВЗД РЕД КРАС},70,10,173)	; Твоз редуц высокая
;dout[24]=valTrackGt({ТВЗД РАСХ КРАС},70,10,174)	; Твоз расходм высокая 
;dout[25]=valTrackGt({ТВЗД ОДО КРАС},70,10,175)	; Твоз одор высокая 

; --- пожар на ГРС по двум сигналам
dout[26]=valTrack(eq({ЯХПЖ ОПЕР КРАС},2)&{ТВ ОПЕР В КРАС},10,176)    ; пожар в операторной
;dout[27]=valTrack(eq({ЯХПЖ ТОПЧ КРАС},2)&{ТВ ТОП В КРАС},10,177)     ; пожар в топочной
dout[28]=valTrack(eq({ЯХПЖ ПЕР КРАС},2)&{ТВ ПЕР В КРАС},10,178)     ; пожар в бл.переключ
dout[29]=valTrack(eq({ЯХПЖ РЕД КРАС},2)&{ТВ РЕД В КРАС},10,179)     ; пожар в бл.редуц
;dout[30]=valTrack(eq({ЯХПЖ РАСХ КРАС},2)&{ТВ РАСХ В КРАС},10,180)     ; пожар в расходомерной
;dout[31]=valTrack(eq({ЯХПЖ ОДОР КРАС},2)&{ТВ ОДОР В КРАС},10,181)     ; пожар в бл.одоризации

; --- перепад на фильтрах
dout[32]=gt({DP ФИЛЬТ1 КРАС},{DР ФЛ ПВ КРАС}) 		; перепад на фильтре1 повыш 
dout[33]=gt({DP ФИЛЬТ1 КРАС},{DР ФЛ В КРАС}) 		; перепад на фильтре1 выс 
dout[34]=gt({DP ФИЛЬТ2 КРАС},{DР ФЛ ПВ КРАС}) 		; перепад на фильтре2 повыш 
dout[35]=gt({DP ФИЛЬТ2 КРАС},{DР ФЛ В КРАС}) 		; перепад на фильтре2 выс 

; --- сработка ППК
dout[36]=gt({РСВ ЛИН КРАС},{РСВЛ МАКС КРАС})	;открытие ппк

; ---- УУГ
dout[37]=valTrackGt({1SF dР КРАС},{DРУГ1МАКС КРАС},20,182)  ; перепад выс
dout[38]=valTrackLt({1SF dР КРАС},{DРУУГ1МИН КРАС},20,183)   ; перепад низ
dout[39]=valTrackGt({1SF Р КРАС},{РУУГ1МАКС КРАС},20,184)  ; давление выс
dout[40]=valTrackLt({1SF Р КРАС},{РУУГ1МИН КРАС},20,185)   ; давление низ

;  давление на регуляторе (на командном газе)
; P < P ВТГ - резерв(0) , P ВТГ <= P <=P ВАГ - работа(1), P > P ВАГ - авария(2)
dout[41]=gt({РРЕГ1 КРАС},{РРЕГ1 ВТГ КРАС})+gt({РРЕГ1 КРАС},{РРЕГ1 ВАГ КРАС})
dout[42]=gt({РРЕГ2 КРАС},{РРЕГ2 ВТГ КРАС})+gt({РРЕГ2 КРАС},{РРЕГ2 ВАГ КРАС})

;---- модули
;dout[43]=

; --- исправность каналов эр-04 4 шт
dout[44]=!dost({ПОЗ ЗАДВ КРАС}) 
dout[45]=er04_nedost({РВЫХ Д1 КРАС})
dout[46]=er04_nedost({РВЫХ Д2 КРАС})
dout[47]=er04_nedost({РВЫХ Д3 КРАС})

;---- состояние грс
;dout[48]=

;----------- переcчет в кг --------
aout[49]=({РВХ КРАС}*10.19716)
aout[50]=({РВЫХ Д1 КРАС}*10.19716)
aout[51]=({РВЫХ Д2 КРАС}*10.19716)
aout[52]=({РВЫХ Д3 КРАС}*10.19716)
aout[53]=({РВЫХ123 КРАС}*10.19716)

;------ Расчет обьема газа при работе на байпасе -----
x=Vbp({КРАН БАЙП КРАС},{1SF ПРСУТ КРАС},54) ; 5переменных

;--------------- БОМ ОВЕН---------------------------------
x=bomOven(121,{БОМСТАТ1 КРАС},{БОМСТАТ2 КРАС})

;---- ИБП
dout[72]=valTrackGt({ENT I НАГ КРАС},0.9*{IМАКС ИБП КРАС},2,186) ; ток нагрузки ибп высокий (номинально smart 30А)
dout[73]=gt({ENT ТБАТ КРАС},70)               		  ; перегрев ибп
dout[74]=lt({ENT UВХ КРАС},185)                 	          ; u вх ибп низкое
dout[75]=gt({ENT UВХ КРАС},245)                		  ; u вх ибп высокое

;---------------- Яхонт 4и -------------------------
a=yahont4(76,{ЯХ ШЛ1})
a=yahont4(77,{ЯХ ШЛ2})
a=yahont4(78,{ЯХ ШЛ3})
a=yahont4(79,{ЯХ ШЛ4})
a=yahont41(80,{ЯХ КОРПУС})
a=yahont42(81,{ЯХ ОСНОВН ИП})
a=yahont42(82,{ЯХ РЕЗЕРВ ИП})

;-------------- СГОЭС --------------------------
dout[88]=sgoes_avar({1СГОЭС КОД})
dout[89]=gt({СН4 ПЕР КРАС},10)
dout[90]=gt({СН4 ПЕР КРАС},20)

dout[91]=sgoes_avar({2СГОЭС КОД})
dout[92]=gt({СН4 РЕД КРАС},10)
dout[93]=gt({СН4 РЕД КРАС},20)

; -------------- БУПГ24-3 -----------------------
x=bupg243(100,{ПГ СОСТ})	
x=bupg243_klap(114,{ПГ СОС КЛ})	











