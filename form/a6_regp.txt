; ГРС Красноусольский
; ПНР Галеев 07.19
; регулирование Pвых газа (КРПБ, контур САУ) +проверка клапана на бп 

#include "eval.lib\set.evl"
#include "eval.lib\klap_test.evl"

func checkNo220(dummy)
  x={UPS1 РЕЖ КРАС}
  return(x)
endfunc

func checkPrecond(dummy)
  x=0
  if (ne({РЕЖИМ ГРС КРАС},0)&ne({КРАН БАЙП КРАС},2))
    x=x|eq({КОНТР РЕГ КРАС},1)		; работа только на контуре САУ
  endif
  return(x)
endfunc

; mode  - 0-ручной; 1-автомат
func pid(id,ki,kp,ref,pos,fdb,fdbtrust,mode)
  return(pidreg(id,ki,kp,0.1,ref,pos,fdb,0,0,100,10,0,0.05,mode,4,1,0,2,0,fdbtrust))
endfunc


; переменные
; 1-30 рег
; 31 - режим рег
; 32 - сигнал упр
; 33 - неисправн крбп
;
func oninit(t)
  bpticks=0
  aout[32]=0
  dout[33]=0	; исправн крбп
  prevhour=curhour(0)
  sleep(5*18)
endfunc



;
; хотя при контуре эр-04 регулятор сау не работает, делаем ради корректного начения переменных
; расчет управления конт сау делается постоянно, вдруг при переходе на бп сразу придется работать
;
mode=checkPrecond(0)
dout[31]=mode
u=pid(1,{S0КИРЕГР КРАС},{S1КПРЕГР КРАС},{РВЫХ ЗАД КРАС},{ПОЗ ЗАДВ КРАС},{РВЫХ123 КРАС},dost({РВЫХ123 КРАС}),mode)

; При работе не на БП изменение "зад полож" приводит к перемещению крана-рег
; если руч режим на бп, сигнал ф-ии pid будет равен текущему положению, ду в это время также блокируется
;                                                                       
if (eq({РЕЖ РЕГ04 КРАС},0)) ; тест бп при не на бп
                             
    u={РУЧПОЛ БП КРАС}	; и перемещение вслед за руч пол
    u=klap_test(u,{РУЧПОЛ БП КРАС},{ПОЗ ЗАДВ КРАС},33,{КРАН БАЙП КРАС},6,{РЕЖИМ ГРС КРАС})
    aout[32]=u
    x=setSens({РУЧ БП04 КРАС}[sys_num],u,0.1)

endif




