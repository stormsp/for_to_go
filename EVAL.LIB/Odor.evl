; Библиотека для работы с одоризаторами
; ОГ-1
; БОМ
; БАОГ
;  
; vi    - номер свободной выходной переменной для таймеров
; 	  	  Требуется 2 шт. При Т=0(разовая засылка) не требуются
; q1    - мгновенный расход газа по прибору учета газа
; qz    - расход газа замещающий, при недостоверных 
;	  	  данных с прибора учета газа (суперфло)
; mode  - режим одоризации 
;    	  для ОГ-1: 0-автоматическое получение расхода газа от САУ(требуется засылка)
;	  	    		1-ручное задание расхода газа
;	  	  для БОМ:  0-автоматич от суперфло (посредством реле)
;		    		1-автоматич от САУ (требуется засылка)
;		    		2-ручное задание расхода газа
; cnt_sys - #сист номер расхода газа одоризатора в который засылать
; Т 	- период засылки. Для разовой засылки(при переходе на байпас) Т=0
; ПРИМЕР ИСПОЛЬЗОВАНИЯ:
; в ините 
;  aout[16]=getticks(0)
;  aout[17]=getticks(0)
; в тексте
;  x=BOM_setq(16,({МГН РАС-1 ДЮРТ}+{МГН РАС-2 ДЮРТ}),{QМГН ЗАМ ДЮРТ},{РЕЖ ОДОР ДЮРТ},{QГ ОДОР ДЮРТ}[sys_num],30)
; или
;  x=BOM_setq(0,({ПР СУТ-1 ДЮРТ}+{ПР СУТ-2 ДЮРТ})/24,{QМГН ЗАМ ДЮРТ},{РЕЖ ОДОР ДЮРТ},{QГ ОДОР ДЮРТ}[sys_num],0)



func setq(q,cnt_sys)
      if (dost(#[cnt_sys]))
        if (gt(abs(#[cnt_sys]-q),5))  	; если расход мало изменился не засылаем
          set cnt_sys,q
        endif
      endif
endfunc

func OG_setq(vi,q1,qz,mode,cnt_sys,T)
  if (ne(mode,0))
	return(0)
  endif

 if eq(T,0) ; Признак разовой засылки(например при переходе на байпас)
  if(dost(q1))
	setq(q1,cnt_sys)
  else
	setq(qz,cnt_sys)
  endif
 else
  if (ge(getticks(aout[vi])*ticksize(),T))
    if (dost(q1))
      setq(q1,cnt_sys)
    else
      if (valTrack(!dost(q1),60,vi+1)); если расход недост ждем 60 сек потом засылаем замещенный
        setq(qz,cnt_sys)
      endif
    endif
    aout[vi]=getticks(0)
   endif
  endif
return(0)
endfunc



func BOM_setq(vi,q1,qz,mode,cnt_sys,T)
  if (ne(mode,1))
	return(0)
  endif

 if eq(T,0) ; Признак разовой засылки(например при переходе на байпас)
  if(dost(q1))
	setq(q1,cnt_sys)
  else
	setq(qz,cnt_sys)
  endif
 else
  if (ge(getticks(aout[vi])*ticksize(),T))
    if (dost(q1))
      setq(q1,cnt_sys)
    else
      if (valTrack(!dost(q1),60,vi+1)); если расход недост ждем 60 сек потом засылаем замещенный
        setq(qz,cnt_sys)
      endif
    endif
    aout[vi]=getticks(0)
   endif
  endif
return(0)
endfunc
