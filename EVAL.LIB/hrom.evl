; ГРС Карманово 
; Хроматограф
; Галеев  2014.07
; 70 переменных
; dout[1-20] - ошибки анализа и калибровки 
; dout[21] - кнопка ручного запроса 
; aout[22] - счетчик
; aout[30-69] - запрошенные параметры


;                          ---------****--------
; при ПНР выставить час окончания калибровки и анализа
; в паспорт {ЧАС КАЛ КАРМ} {ЧАС АНАЛ КАРМ} c учетом времени в КП(местн или московск)
;                          ----------***-------

; Расшифровка ошибок хроматографа
; 16 dout 
func hr_o(a,cod)
  dout[a+0]=ne(cod & 1, 0)	; Температура колонки вышла за максимальную границу
  dout[a+1]=ne(cod & 2, 0)	; Температура колонки вышла за минимальную границу
  dout[a+2]=ne(cod & 4, 0)	; Авария по давлению: меньше 4.0 атм
  dout[a+3]=ne(cod & 8, 0)	; Резерв
  dout[a+4]=ne(cod & 16, 0)	; Авария по давлению: меньше 1.7 атм
  dout[a+5]=ne(cod & 32, 0)	; Резерв
  dout[a+6]=ne(cod & 64, 0)	; Температура нити детектора вышла за максимальную границу
  dout[a+7]=ne(cod & 128, 0)	; Температура нити детектора вышла за минимальную границу
  dout[a+8]=ne(cod & 256, 0)	; Ток нити детектора вышел за максимальную границу
  dout[a+9]=ne(cod & 512, 0)	; Ток нити детектора вышел за минимальную границу
  dout[a+10]=ne(cod & 1024, 0)	; Во время анализа пропадала связь с м/к БУ
  dout[a+11]=ne(cod & 2048, 0)	; Во время анализа зафиксированы рестарты м/к БУ
  dout[a+12]=ne(cod & 4096, 0)	; Во время анализа зафиксированы аварии ДТП
  dout[a+13]=ne(cod & 8192, 0)	; Выход одного из компонентов за технологический допуск
  dout[a+14]=ne(cod & 16384, 0)	; Выход одного из компонентов за аварийный допуск
  dout[a+15]=ne(cod & 32768, 0)	; Флаг ошибок изменен пользователем
endfunc 

; Перенос значений из области результата запроса в расчетные параметры БД
; i - номер переменной блока расч параметров БД
; k - #sys начала области БД modbus соотв области адресов результ запроса
;
; число выводимых параметров 40 
; список парам модбас в редакторе структуры базы данных
; д.быть в таком же порядке как в этой базе (ГРС Карманово)
; т.к. вычислитель обращается к ним по сис номеру в зависимости от первого параметра
; 
func queryarea2db(i,k)
    aout[i+0]=#[k+0]
    aout[i+1]=#[k+1]
    aout[i+2]=#[k+2]
    aout[i+3]=#[k+3]
    aout[i+4]=#[k+4]
    aout[i+5]=#[k+5]
    aout[i+6]=#[k+6]
    aout[i+7]=#[k+7]
    aout[i+8]=#[k+8]
    aout[i+9]=#[k+9]
    aout[i+10]=#[k+10]
    aout[i+11]=#[k+11]
    aout[i+12]=#[k+12]
    aout[i+13]=#[k+13]
    aout[i+14]=#[k+14]
    aout[i+15]=#[k+15]
    aout[i+16]=#[k+16]
    aout[i+17]=#[k+17]
    aout[i+18]=#[k+18]
    aout[i+19]=#[k+19]
    aout[i+20]=#[k+20]
    aout[i+21]=#[k+21]
    aout[i+22]=#[k+22]
    aout[i+23]=#[k+23]
    aout[i+24]=#[k+24]
    aout[i+25]=#[k+25]
    aout[i+26]=#[k+26]
    aout[i+27]=#[k+27]
    aout[i+28]=#[k+28]
    aout[i+29]=#[k+29]
    aout[i+30]=#[k+30]
    aout[i+31]=#[k+31]
    aout[i+32]=#[k+32]
    aout[i+33]=#[k+33]
    aout[i+34]=#[k+34]
    aout[i+35]=#[k+35]
    aout[i+36]=#[k+36]
    aout[i+37]=#[k+37]
    aout[i+38]=#[k+38]
    aout[i+39]=#[k+39]
endfunc

func oninit(t)

  initouts 1,0,16 ; инициализация нулем 16-ти

  dout[20]=0 ; ошибка калибровки обновится в час окончания калибровки

  sleep(5*18)
  set {РЕЖ ЗА ХР КАР}[sys_num],1
  prevhour=hour(time()) 

 ; для запроса средних значений за указанную дату
 ; значения по умолчанию
  set {FlagStat КАР}[sys_num], 1 			; среднесуточные
  set {KodBase КАР}[sys_num], 0 			; рабочие анализы
  set {MonthBaseКАР}[sys_num], month(time()-86400)	; месяц вчерашнео дня
  set {YearBase КАР}[sys_num], year(time()-86400)	; год вчерашнео дня
  set {DayBase КАР}[sys_num], 0			; день д.б. 0
  set {HourBase КАР}[sys_num], 10			; час анализа 10
  set {PosBase КАР}[sys_num], monthday(time()-86400)	; здесь день месяца анализа

  set {КН ЗАПР КАР}[sys_num],1	; так инициируем внеочеред запрос средних при перезагр

endfunc

; --------------- Вычисление ошибок -----------------------------------------------
;
x=hr_o(1,{FLAG ERROR КАР})
dout[17]=ne({FLAG ERROR КАР},0) ; ХОТЯ БЫ ОДНА ИЗ 16  ОШИБОК
dout[19]=ne({FLAG1ERROR1},0) ; ОШИБКИ АНАЛИЗА СРЕДН ВЫБОРОК 2

; --------------  получение средних значений (в ручном режиме) ---------------------
;
if (eq({КН ЗАПР КАР},1))

  LOCK_ARCH 6,4 ; начать работу с областью адр pgc

  set {РЕЖ ЗА ХР КАР}[sys_num],0 ; отключаем автомат
  z=set_uncond({ФЛАГ ВЫБ КАР}[sys_num],{FlagStat КАР})
  z=set_uncond({КОД БАЗЫ КАР}[sys_num],{KodBase КАР})
  z=set_uncond({МЕС ВЫБ КАР}[sys_num],{MonthBaseКАР})
  z=set_uncond({ГОД ВЫБ КАР}[sys_num],{YearBase КАР})
  z=set_uncond({ДЕНЬ ВЫБ КАР}[sys_num],{DayBase КАР})
  z=set_uncond({ЧАС ВЫБ КАР}[sys_num],{HourBase КАР})
  z=set_uncond({ПОЗ АНАЛ КАР}[sys_num],{PosBase КАР})

  set {РЕЖ ЗА ХР КАР}[sys_num],1
  set {КН ЗАПР КАР}[sys_num],0

  ; ожидание процедуры запроса, опрос идет..
  ;
  sleep(20*18)

  ; обработка результатов запроса 
  ;
  if(eq({КОД БАЗЫ КАР},0))
    z=queryarea2db(30,{ЧИС АН ВЫБ  М}[sys_num])
  endif

  UNLOCK_ARCH 6,4 ; завершить работу с областью адр pgc

endif

; --------------  получение средних значений (в режиме автомат) ---------------------
; 

h1=hour(time()) 		; текущий час
d1=monthday(time()-86400)  	; вчерашний день месяца
m1=month(time()-86400)		; вчерашний месяц
y1=year(time()-86400)		; вчерашний год

if (eq({РЕЖ ЗА ХР КАР},1)&ne(h1,prevhour)&(eq(h1,{ЧАС АНАЛ КАР})|eq(h1,{ЧАС КАЛ КАР}+1))); час анализа

  LOCK_ARCH 6,4 ; начать работу с областью адр pgc

  z=set_uncond({ФЛАГ ВЫБ КАР}[sys_num],1)
  z=set_uncond({КОД БАЗЫ КАР}[sys_num],0)
  z=set_uncond({МЕС ВЫБ КАР}[sys_num],m1)
  z=set_uncond({ГОД ВЫБ КАР}[sys_num],y1)
  z=set_uncond({ДЕНЬ ВЫБ КАР}[sys_num],0)
  z=set_uncond({ЧАС ВЫБ КАР}[sys_num],10)
  z=set_uncond({ПОЗ АНАЛ КАР}[sys_num],d1)

  ; ожидание процедуры запроса, опрос идет..
  ;
  sleep(20*18)

  ; обработка результатов запроса 
  ;
  if(eq({КОД БАЗЫ КАР},0))
    z=queryarea2db(30,{ЧИС АН ВЫБ  М}[sys_num])
  endif

  UNLOCK_ARCH 6,4 ; завершить работу с областью адр pgc

endif

; --------------  получение результата калибровки (в режиме автомат) ---------------------
;
if (eq({РЕЖ ЗА ХР КАР},1)&ne(h1,prevhour)&eq(h1,{ЧАС КАЛ КАР})) ; час калибровки
 
  LOCK_ARCH 6,4 ; начать работу с областью адр pgc

  z=set_uncond({ФЛАГ ВЫБ КАР}[sys_num],0)
  z=set_uncond({КОД БАЗЫ КАР}[sys_num],1)
  z=set_uncond({МЕС ВЫБ КАР}[sys_num],0)
  z=set_uncond({ГОД ВЫБ КАР}[sys_num],0)
  z=set_uncond({ДЕНЬ ВЫБ КАР}[sys_num],0)
  z=set_uncond({ЧАС ВЫБ КАР}[sys_num],-1)
  z=set_uncond({ПОЗ АНАЛ КАР}[sys_num],0)

  ; ожидание процедуры запроса, опрос идет..
  ;
  sleep(20*18)

  ; обработка результатов запроса 
  ;
  if(eq({КОД БАЗЫ КАР},1)) 		; если таблица калибровочная
    dout[20]=eq({FLAG1ERROR2},1) 	; считываем ошибку калибровки
  endif

  UNLOCK_ARCH 6,4 ; завершить работу с областью адр pgc

endif
prevhour=h1
