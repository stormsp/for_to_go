; ПС раскачка регулятора нитки
; Не более чем за 2 минут проходит 2 цикла 
; Цикл состоит из следующей последовательности
; скор.dP1 (16.1) > скор.dPзад. (6.6) потом 
; скор.dP1 (16.1)<0 
; цикл закончился
; Сброс, если за 2 минуты не было ни одного срабатывания условий
;
; vdp - значение скорости перепада рег нитки
; vdpmax - макс скорость
; vi - номер первой переменной из 6 
;      где +0-+3 времена фиксации последних 4 событий
;      +4 - знак последнего события (0 минус, 1 плюс, 2 начальное)
;      +5 - общее к-во событий
;
func shiftb(vi,event)
  aout[vi+0]=aout[vi+1]
  aout[vi+1]=aout[vi+2]
  aout[vi+2]=aout[vi+3]
  aout[vi+3]=getticks(0)
  dout[vi+4]=event       		; 1-скорость сильно в плюс, 0 - в минус
  aout[vi+5]=aout[vi+5]+1               ; число горбов с момента запуска зонд
endfunc

func raskach(vp,vpmin,vpmax,vi)
  if (gt(vp,vpmax)&ne(dout[vi+4],1))	; событие +
    x=shiftb(vi,1)
  endif
  if (lt(vp,vpmin)&ne(dout[vi+4],0))	; событие -
    x=shiftb(vi,0)
  endif
  return(ge(aout[vi+5],4)&lt((aout[vi+3]-aout[vi+0])*ticksize(),120))
endfunc



; режим работы регуляторов
; 0-резерв
; 1-работа
; 2-авария
func regim(p, ust_rab, ust_avar)
  if lt(ust_rab,ust_avar)
    if lt(p,ust_rab)
      return(0)
    else
      if gt(p,ust_avar)
        return(2)
      else
        return(1)
      endif
    endif
  endif
  return(false(0))
endfunc
