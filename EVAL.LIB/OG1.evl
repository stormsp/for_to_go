; Библиотека для работы с одоризатором ОГ-1 ИТЦ
; #include "eval.lib\OG1.evl"

; vi    - номер свободной выходной переменной для таймеров
; 	  	  Требуется 2 шт. При Т=0(разовая засылка) не требуются
; q1    - мгновенный расход газа по прибору учета газа
; qz    - расход газа замещающий, при недостоверных 
;	  	  данных с прибора учета газа (суперфло)
; mode  - режим одоризации 
;    	  для ОГ-1: 	0-автоматическое получение расхода газа от SFlow
;			1- от САУ(требуется засылка)
;	  	    	2-ручное задание расхода газа
; cnt_sys - #сист номер расхода газа одоризатора в который засылать
; Т 	- период засылки.



func setq(q,cnt_sys)
      if (dost(#[cnt_sys]))
        if (gt(abs(#[cnt_sys]-q),5))  	; если расход мало изменился не засылаем
          set cnt_sys,q
        endif
      endif
endfunc

func setq_one(q,qz,cnt_sys)
  if dost(q)
    x=setq(q,cnt_sys)
  else
    x=setq(qz,cnt_sys)
  endif
endfunc

func setq_periodic(vi,q1,qz,mode,cnt_sys,T)
  if (ne(mode,1)) ; не автомат расход
	return(0)
  endif

  if (ge(getticks(aout[vi])*ticksize(),T))
    if (dost(q1))
      x=setq(q1,cnt_sys)
  else
      if (valTrack(!dost(q1),60,vi+1)); если расход недост ждем 60 сек потом засылаем замещенный
        x=setq(qz,cnt_sys)
      endif
    endif
    aout[vi]=getticks(0)
   endif

return(0)
endfunc

func set_mode (dummy)
  
endfunc
