; ГРС Красноусольский
; Галеев 07.2019
; Мелкие алгоритмы, влияющие на объекты

;
; час текущего времени сау
;
func curhour(dummy)
 curtime=time()
 return(hour(curtime))
endfunc


#include "eval.lib\set.evl"
#include "eval.lib\valtrack.evl"

#include "eval.lib\front.evl"
#include "eval.lib\regim.evl"
#include "eval.lib\bom.evl"


; Переменные
; 1,2 - оператор 1,2 зарег
; 4 - режим ту грс
; 5-8 - слеж за ком-кнопками
; 9-10 - задержка при восст команд реж ту грс
; 11-12 - тела команд реж ту грс
; 13-14 - расчет связи c бусами
; 15 - расчет времени отсутствия связи с бусами
; 16 - слеж за временем одоризатор
; 18 - слеж за ком перевода в режим от алг
; 19 - тело команды перевода в режим от алгоритма
;
func oninit(t)
b=0
d=0
  prevhour=curhour(0)
  dout[1]=0
  dout[2]=0
  aout[3]=0
  dout[4]={АВТОЗАПУСКР}          ; уст извне, сохранение при перезагр
  dout[5]=0                      ; при старте, считаем, кнопки не нажаты
  dout[6]=0
  dout[7]=0
  dout[8]=0
  aout[9]=0
  aout[10]=0
  dout[11]=0
  dout[12]=0
  aout[15]=0

  dout[18]={АВТОЗАПУСКР}
  dout[19]={АВТОЗАПУСКР}
  dout[21]=0
  aout[22]=0
  dout[23]=0

  aout[24]=0
  aout[25]=0
  aout[26]=0
  aout[27]=0
  sleep(5*18)

endfunc


; реакция на команды и кнопки перехода в режим
;
x=modes(4,{КОМ РЕЖ1 КРАС},{КОМ РЕЖ2 КРАС},{КН РЕЖ1 КРАС},{КН РЕЖ2 КРАС})
x=cmdmode_in(4,18,{КОМ РЕЖ3})


;
; блокировка команд ТУ в режимах АРМ и ПУДП (1-команды разрешены)
; режим грс 0-по месту, 1-пу, 2-арм
;
; упр кранами
;
set {ТУ ОБ СПУ}[sys_num],eq({РЕЖИМ ГРС КРАС},1)
set {ТУ ОБ АРМ}[sys_num],eq({РЕЖИМ ГРС КРАС},2)


; режим неуправляемый, при изменениях сохраняем на диск
;
set {АВТОЗАПУСКР}[sys_num],{РЕЖИМ ГРС КРАС}


; если режим пу дп и нет связи с дп - перевести режим в арм
; 300сек- в modbus_s "время обрыва связи"
;
if(eq({РЕЖИМ ГРС КРАС},1)&eq(dost({СВЯЗ ЛПУ КРАС}),1)&eq({СВЯЗ ЛПУ КРАС},0))
  dout[4]=2
endif


; если нет связи с бус в течение 120с - выдать сигнализацию
;
dout[13]=valTrack(eq(dost({СВЯЗЬ С БУС1}),1)&!{СВЯЗЬ С БУС1},120,21)
dout[14]=valTrack(eq(dost({СВЯЗЬ С БУС2}),1)&!{СВЯЗЬ С БУС2},120,22)

;-------------- засылка расхода газа в одоризатор -------------
;
if (eq({КРАН БАЙП КРАС},2))
  x=setq_periodic(16,{1SF QМГН КРАС},{Q ЗАМ1 КРАС},{РЕЖ ОДОР1 КРАС},{QАВТ БОМ КРАС}[sys_num],30)
endif